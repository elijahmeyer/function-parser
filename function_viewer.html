<!DOCTYPE html>
<html>

    <head>
        <meta charset="utf-8">
        <title>M7700 Function Viewer</title>
        <script src="https://d3js.org/d3.v4.min.js"></script>
        
        <script language="javascript" type="text/javascript">
            function processFiles() {
                var jsonName1 = "./bin_functions/" + document.forms["fileselect"]["file1"].value
                d3.json(jsonName1, function(error, json) {
                    console.log(json)
                    update(d3.values(json), "#binary1")
                              
                })
                
                var jsonName2 = "./bin_functions/" + document.forms["fileselect"]["file2"].value
                d3.json(jsonName2, function(error, json) {
                    console.log(json)
                })
                
            }


            function update(source, svg_name) {

                d3.select(svg_name).selectAll('*').remove()
                
                var height = 5000
                var width = 5000

                var chart = d3.select(svg_name)
                              .attr("height", height)
                              .attr("width", width)

                var simulation = d3.forceSimulation()
                                   .force("center_force", d3.forceCenter(width / 2, height / 2))
                                   .force("repel_force", d3.forceManyBody().strength(-100))
                 
      
                var subroutine = chart.selectAll("g")
                                      .data(source)
                                      .enter().append("g")

                
                subroutine.append("rect")
                          .attr("width", 250)
                          .attr("height", 150)
                          .style("fill", "blue")
/*
                var subroutine = chart.append("g")
                                      .selectAll("rect")
                                      .data(source)
                                      .enter().append("rect")
                                      .attr("width", 250)
                                      .attr("height", 150)
                                      .style("fill", "blue")
*/
                var subroutine_text = subroutine.append("text")
                              .attr("x", 0)
                              .attr("y", 0)
                            .append("tspan")
                              .attr("x", 0)
                              .attr("dy", "1.2em")
                              .text(function(d,i) { return d.base_addr })

                subroutine.each(function(d,i) {
                    for (let access in d.accesses) {
                        d3.select(this).select("tspan").append("tspan")
                                      .attr("x", 0)
                                      .attr("dy", "1.2em")
                                      .text(function() { 
                                          return d.accesses[access][1] + " (" + d.accesses[access][0] + ")"
                                      })
                   }
               })

                       
               subroutine_text.append("tspan")
                              .attr("x", 0)
                              .attr("dy", "1.2em")
                              .text(function(d,i) { return d.instruction_count + " instructions" })

               subroutine_text.append("tspan")
                              .attr("x", 0)
                              .attr("dy", "1.2em")
                              .text(function(d,i) { return d.JSR_count + " JSR calls" })

               subroutine_text.append("tspan")
                              .attr("x", 0)
                              .attr("dy", "1.2em")
                              .text(function(d,i) { return (+d.JSR_count / +d.instruction_count).toFixed(2) + " JSR calls per instruction" })

               var link_data = findLinks(source)
               var link_force = d3.forceLink()
                                  .id(function(d) { return d.base_addr })
                                  .distance(2000)
                                  .strength(1)

               simulation.force("link", link_force)

               var link = chart.append("g")
                               .selectAll("line")
                               .data(link_data)
                               .enter().append("line")
                                 .attr("stroke-width", 2)
                                 .attr("stroke", "black")

               simulation.nodes(source)
               simulation.force("link")
                         .links(link_data)

               simulation.on("tick", function() {
                   subroutine
                      .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")" })

                   link
                      .attr("x1", function(d) { return d.source.x })
                      .attr("y1", function(d) { return d.source.y })
                      .attr("x2", function(d) { return d.target.x })
                      .attr("y2", function(d) { return d.target.y })
               })


            }


            function findLinks(source) {

                var linkArray = []
                for (let subroutine in source) {
                    for (let child in source[subroutine].children) {
                        var link = {
                            'source': source[subroutine].base_addr,
                            'target': source[subroutine].children[child]
                        }
                        //console.log(link)
                        linkArray.push(link)
                    }
                }
                return linkArray

            }

        </script>
    </head>

    <body>
        <h1>Select the Binaries to Examine:</h1>
        <form name="fileselect">
            <select name="file1" required="true">
            </select>
            <br><br>
            <select name="file2" required="true">
            </select>
            <br><br>
            <input type="button" value="View Functions" onclick=processFiles()>
        </form>
        <br><br>
        <svg id="binary1"></svg>
        <br><br>
        <svg class="chart" ids="binary2"></svg>
        <script language="javascript" type = "text/javascript">
            <!--
                // index.txt is a file generated by ClusterBins.py that lists all of the files
                // analyzed during the clustering. This file has one file name per line.
                d3.text("./bin_functions/index.txt", function(text) {
                    console.log(text)
                    var data = text.split("\n")
                    console.log("Data:\n")
                    console.log(data)
            
                    // Because the data array is split by newlines and the file ends with a newline,
                    // the final element in the data array will always be an empty string "".
                    // Omit this from the options so that there is not a blank dropdown option.
                    d3.selectAll("select")
                      .selectAll("option")
                        .data(data.slice(0, data.length-1))
                      .enter().append("option")
                      .attr("value", function(d) { return d + ".json" } )
                      .text(function(d) { return d } )
                })
                
                
            // -->
        </script>
    </body>

</html>
